exports.createPublication = async (req, res) => {
  try {
    const { visibilite, legende } = req.body;
    
    if (!['Public', 'Groupe'].includes(visibilite)) {
      return res.status(400).json({ message: 'Visibilité invalide' });
    }

    if ((!req.files['fichiers'] || !req.files['fichiers'].length) && !legende) {
      return res.status(400).json({ message: 'Le contenu de la publication ne peut pas être vide.' });
    }

    const photo = req.files['photo'] ? req.files['photo'][0] : null;

    const publication = await publicationService.createPublication(req, req.files['fichiers'], photo);

    // Notifie les utilisateurs de la nouvelle publication via Socket.io
    req.io.emit('newPublication', { 
      message: 'Nouvelle publication créée', 
      publication 
    });
    
    return res.status(200).json({ message: 'Publication créée avec succès', publication });
  } catch (error) {
    return res.status(400).json({ message: error.message });
  }
};
